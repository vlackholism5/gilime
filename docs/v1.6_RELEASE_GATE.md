# v1.6 Release Gate (MVP3 Admin Alert Ops)

## 스모크 S1~S7

| # | 항목 | 절차 |
|---|------|------|
| **S1** | alert_ops 로드·필터 | `/admin/alert_ops.php` 접속 → 목록 로드 확인. event_type / route_label / published_from / published_to 필터 적용 후 재요청 → 결과 변경 확인. |
| **S2** | admin에서 알림 1건 생성 | alert_ops 상단 "새 알림 작성" 폼에서 event_type, title, ref_id, route_label, published_at(필수) 입력 후 제출. "created" 또는 "duplicate ignored" muted 메시지 + 리스트 상단/강조 확인. |
| **S3** | user 알림 노출 확인 | `/user/alerts.php?route_label=R1` 접속 → S2에서 만든 알림이 노출되는지 확인. |
| **S4** | deliveries 1건 기록 확인 | 사용자 알림 페이지 진입 시 record_alert_delivery로 app_alert_deliveries에 기록. `/admin/alert_event_audit.php`에서 alert_event_id 또는 user_id로 필터 → 1건 이상 확인. UNIQUE로 중복 0건. |
| **S5** | create contract (v1.6-06) | 필수값(event_type, title, ref_id, route_label, published_at) 누락 시 create 차단 + 메시지. 동일 입력 2회 시 1회 created, 2회 duplicate ignored. |
| **S6** | audit drilldown + summary (v1.6-07) | event_id/user_id/channel/status/since 필터. 상단 요약 1줄(delivery_cnt, min/max created_at). event_id → alert_ops, user_id → audit 드릴다운. |
| **S7** | alerts delivery guard (v1.6-08) | user_id 미확정이면 delivery 기록 안 함. 동일 요청에서 렌더 목록만 루프 1회 기록. 새로고침 시 deliveries 증가 없음(ON DUPLICATE KEY UPDATE). |

## 실행 순서

1. S1 → S2 → S3 → S4 → S5 → S6 → S7 순서 권장.

---

## Evidence (결과 붙여넣기 후 채움)

아래는 게이트 통과 시 증거값으로 채우는 블록입니다.  
**최소 세트:** (1) app_alert_events EID 확인 SELECT 결과 5건 + (2) app_alert_deliveries (A)(B)(C) 결과를 붙여넣어 주시면, 여기에 요약을 반영하고 통과/보완 판정을 내립니다.

- **EID** (방금 생성 이벤트 id): **4**
- **이벤트**: id=4, event_type=update, title=[E2E test] v1.4-10, ref_id=1, route_label=R1, published_at=2026-02-11 02:39:37.
- **S2** (admin 생성): created 플래시 + 리스트 1건 추가 확인.
- **S3** (user 노출): `/user/alerts.php?route_label=R1` 에 해당 title 노출, Review 링크 있음. _(텍스트 확인)_
- **S4 (A)** `delivery_cnt`: **2** (기대 ≥ 1 ✓)
- **S4 (B)** event_id=4 deliveries 2건: id=67 (user_id=2, channel=web, status=shown), id=16 (user_id=1, channel=web, status=shown).
- **S4 (C)** `HAVING COUNT(*) > 1`: **0 rows** (중복 없음 ✓)
- **S1 (선택)** event_type='strike' cnt / route_label='R1' cnt: _(선택 생략)_

---

**판정: v1.6-05 게이트 통과.** S1~S4 증거 충족. deliveries 2건(user_id 1, 2 / channel=web, status=shown), UNIQUE로 중복 0건 확인.

---

## Evidence 복붙용 SQL 블록 (v1.6-10)

아래를 Workbench/CLI에서 실행 후 결과를 문서에 붙여넣어 증거화할 수 있습니다. `:EID`는 방금 생성한 이벤트 id로 치환.

```sql
-- 1) 이벤트 조회 (EID 확정)
SELECT id, event_type, title, ref_id, route_label, published_at, created_at
FROM app_alert_events
WHERE ref_type='route' AND ref_id=1 AND route_label='R1'
ORDER BY id DESC
LIMIT 5;

-- 2) delivery count
SELECT COUNT(*) AS delivery_cnt
FROM app_alert_deliveries
WHERE alert_event_id = :EID;

-- 3) delivery list (최근 20건)
SELECT id, alert_event_id, user_id, channel, status, sent_at, created_at
FROM app_alert_deliveries
WHERE alert_event_id = :EID
ORDER BY id DESC
LIMIT 20;

-- 4) 중복 없음 확인 (0 rows 기대)
SELECT user_id, alert_event_id, channel, COUNT(*) AS c
FROM app_alert_deliveries
WHERE alert_event_id = :EID
GROUP BY user_id, alert_event_id, channel
HAVING COUNT(*) > 1;
```
