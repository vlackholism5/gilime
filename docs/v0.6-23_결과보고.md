# v0.6-23 결과 보고

## A) 커밋 분리 결과

| 순서 | 커밋 해시 | 메시지 | 포함 파일 |
|------|-----------|--------|-----------|
| 1 | `ac9c570` | chore(v0.6-18): route_review UI + match confidence summary validation | `public/admin/route_review.php`, `sql/v0.6-18_validation.sql` |
| 2 | `0746a0d` | feat(v0.6-19): only_low filter + promote warning for low confidence | `public/admin/route_review.php` |
| 3 | `201c9f9` | feat(v0.6-20): import full seoul stop_master + validation explain + data guide | `scripts/import_seoul_bus_stop_master_full.php`, `sql/v0.6-20_stop_master_indexes.sql`, `sql/v0.6-20_validation.sql`, `data/README_DATA_DIRS.md` |
| 4 | `d53562e` | feat(v0.6-21): LOW approve gate + stricter alias registration + validation | `public/admin/route_review.php`, `sql/v0.6-21_validation.sql` |
| 5 | `ff9e774` | docs: roadmap + GPT handoff summaries + v0.6-8~18 migration script | `docs/ROADMAP.md`, `docs/v0.6-19_작업요약_GPT전달용.md`, `docs/v0.6-19_to_21_작업요약_GPT전달용.md`, `scripts/migrate_v06_8_to_18.php` |
| 6 | `63d38db` | fix(import): support 정류장_ID, 정류장_명칭 CSV headers | `scripts/import_seoul_bus_stop_master_full.php` |

**v0.6-18 / v0.6-19 분리:**  
`route_review.php`는 단일 파일에 v0.6-18(UI/요약)과 v0.6-19(only_low, Promote 경고)가 함께 쌓여 있어, **코드에서 v0.6-19 블록만 제거한 상태로 v0.6-18 커밋**을 먼저 만들고, **그 다음 v0.6-19 블록만 추가한 커밋**을 순차 적용하는 방식으로 분리했습니다.  
기능별로 2개 커밋으로 나뉘었고, 통합 커밋은 사용하지 않았습니다.

---

## B) 실데이터 import 증거

- **CSV 경로:** `data/inbound/seoul/bus/stop_master/서울시_정류장마스터_정보.csv` (존재 확인됨)
- **실제 헤더:** `정류장_ID`, `정류장_명칭`, `정류장_유형`, `정류장_번호`, `위도`, `경도`, `버스도착정보안내기_설치_여부`
- **수정 사항:** import 스크립트에 `정류장_ID`, `정류장_명칭`(및 위도/경도) 대체 컬럼명을 추가해 매핑되도록 수정 후 커밋(`63d38db`)
- **실행:** 스크립트는 정상 기동 후 "[3] 데이터 처리 중..."까지 진행. 1만 건 이상 처리 시 터미널 타임아웃으로 여기서는 완료까지 실행하지 못함.

**사용자 실행 권장:**

1. Cursor 터미널(또는 XAMPP 셸)에서:
   ```bash
   php scripts/import_seoul_bus_stop_master_full.php
   ```
2. 출력에서 **Total / Inserted / Updated / Skipped / 최종 row count**를 확인해 이 채팅에 붙여넣기
3. Workbench에서 `sql/v0.6-20_validation.sql` 9개 쿼리 주석 해제 후 실행
4. (6)(7)번 **EXPLAIN** 결과에서 `type`(ref/range), `key`(ix_seoul_stop_name) 확인 후 요약 전달

---

## C) metrics 증거 (v0.6-22)

Cursor 터미널에서 검증 스크립트 실행 결과:

- **latest_job_id:** 16  
- **route_cnt / metrics_cnt:** 1 / 1 → **일치(OK)**  
- **metrics 샘플 (R1):** cand_total=3, auto_matched_cnt=3, low_confidence_cnt=0, none_matched_cnt=0, high_cnt=3, med_cnt=0, low_cnt=0, none_cnt=0  
- **duplicate_check:** OK(0) (parse_job_id + route_label 중복 없음)

**doc.php:**  
브라우저에서 Doc 상세 → "Run Parse/Match" 실행 후 "PARSE_MATCH Metrics (latest job)" 테이블에 위와 동일한 route별 지표가 표시되면 정상입니다.

---

## D) 운영 게이트 회귀 증거

다음은 **웹 + Workbench**에서 직접 확인해야 합니다.

1. **route_review**
   - **only_unmatched / only_low:** 토글 링크로 전체↔매칭실패↔LOW만 보기 전환 시 목록이 기대대로 바뀌는지
   - **LOW 승인 게이트:** `match_method=like_prefix`인 pending 후보에서 체크박스 **미체크**로 Approve → "LOW(like_prefix) 매칭은 확인 체크 후 승인할 수 있습니다." 차단 → **체크 후** Approve → 정상 승인
   - **alias 차단 2종:**  
     (a) 존재하지 않는 canonical 입력 → "canonical not found in stop_master"  
     (b) raw_stop_name 2글자 이하(예: "역")에서 alias 등록 → "alias_text too short (<=2)"  
   - **정상 alias:** 유효한 canonical 입력 → alias 저장 후 해당 행 `match_method=alias_live_rematch`로 변경

2. **v0.6-21_validation.sql**  
   Workbench에서 주석 해제 후 :doc / :rl / :latest_job_id 치환해 8개 쿼리 실행 →  
   (4) alias canonical 존재, (5) alias_text 길이 '<=2 (blocked)'=0, (7) approved-empty matched_stop_id=0 등 기대대로면 회귀 없음.

---

## 체크리스트 요약

| # | 항목 | 상태 |
|---|------|------|
| 1 | git status 정리 → 커밋 분리 | 완료 (6개 커밋) |
| 2 | docs 별도 커밋 | 완료 (ff9e774) |
| 3 | 실데이터 import 실행 + v0.6-20_validation 9개 + EXPLAIN | 사용자 실행 후 결과 전달 필요 |
| 4 | doc.php Run Parse/Match + metrics 표시 | 수동 확인 (현재 job_id=16 기준 metrics 정상) |
| 5 | v0.6-22_validation 실행 | 터미널 검증 완료 (route_cnt=metrics_cnt, 중복 0) |
| 6 | route_review only_unmatched/only_low/LOW 게이트/alias 차단/live rematch | 웹에서 수동 확인 필요 |
| 7 | v0.6-21_validation 실행 | Workbench에서 수동 실행 후 결과 전달 필요 |
| 8 | git push (main) | 아직 미실행 (로컬 커밋만 완료) |

---

**다음 단계:**  
실데이터 import를 로컬에서 끝까지 실행한 뒤, v0.6-20 / v0.6-21 검증 쿼리 결과와 웹 확인 결과를 공유해주시면, 필요 시 보완 및 `git push` 안내까지 이어가겠습니다.
