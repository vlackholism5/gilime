# v0.6-19 ~ v0.6-21 작업 요약 (GPT 전달용)

아래 블록 전체를 복사해 GPT에 붙여넣으면 됩니다.

---

```
[작업 완료] v0.6-19 ~ v0.6-21 + UI 개선 + 마이그레이션

[프로젝트] GILIME_MVP_01 (PHP + MySQL, XAMPP)
[레포] https://github.com/vlackholism5/gilime (main 브랜치)
[현재 버전] v0.6-21

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[v0.6-21: 운영 안전장치 강화]

1. LOW 승인 게이트 (서버+UI)
   - match_method='like_prefix'인 pending 후보는 체크박스 "LOW(like_prefix) 확인함" 체크 후에만 Approve 가능
   - 미체크 시 서버에서 차단: "LOW(like_prefix) 매칭은 확인 체크 후 승인할 수 있습니다."
   - DB UPDATE 없이 즉시 차단
   - LOW가 아닌 후보는 기존처럼 체크박스 없이 바로 승인 가능

2. alias 등록 검증 강화 (서버)
   a) canonical이 stop_master에 **존재해야만** alias 저장 허용
      - lookupStopMasterByCanonical() 사용 (인덱스 기반)
      - 존재하지 않으면: "alias blocked: canonical not found in stop_master"
   b) alias_text(정규화 후) **길이 <=2** 이면 저장 차단
      - 에러: "alias blocked: alias_text too short (<=2)"
   - 검증 통과 시에만 alias 저장 + live rematch

3. 검증 쿼리
   - sql/v0.6-21_validation.sql (8개): LOW pending/approved, alias canonical 존재, alias_text 길이, 회귀

4. 매칭 로직/SoT 불변
   - 승인/등록 단계의 게이트만 강화

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[v0.6-20: seoul_bus_stop_master 실데이터 import]

1. Import 스크립트
   - scripts/import_seoul_bus_stop_master_full.php
   - euc-kr CSV → UTF-8, 헤더 자동 매핑, UPSERT, idempotent
   - 입력: data/inbound/seoul/bus/stop_master/서울시_정류장마스터_정보.csv (Git 커밋 금지)
   - 실행: php scripts/import_seoul_bus_stop_master_full.php (Cursor 터미널)

2. 검증 쿼리
   - sql/v0.6-20_validation.sql (9개): row count, 인덱스, EXPLAIN(type/key), match_method 분포

3. 인덱스
   - stop_name 인덱스 확인만 (v0.6-10 기존)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[v0.6-19: LOW 필터 + Promote 경고]

1. only_low 필터
   - GET only_low=1 시 match_method='like_prefix'만 표시
   - only_unmatched와 동시 사용 가능

2. 토글 링크
   - "LOW만 보기" / "LOW 해제"
   - only_unmatched와 파라미터 조합 유지

3. Promote 경고
   - low_confidence_cnt/auto_matched_cnt >= 30% 시 주황색 경고
   - "⚠️ 주의: like_prefix(LOW) 비중이 높습니다. Promote 전 후보를 재검토하세요."

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[UI 개선 (v0.6-18)]

1. Summary 카드 그리드 (4개 + 4개): Total / Approved / Pending / Route Stops + Auto Matched / Low Confidence / None Matched / Alias Used
2. 배지: status(pending/approved/rejected), 신뢰도(HIGH/MED/LOW/NONE) — 색상 구분
3. Action 버튼 세로 배치: 각 form이 회색 카드로 감싸짐, 아이콘 추가
4. 전체 색상·간격·가독성 개선

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[마이그레이션 완료]

- scripts/migrate_v06_8_to_18.php 실행 완료
- 테이블: seoul_bus_stop_master(10건 더미), shuttle_stop_alias(3건 더미), shuttle_stop_normalize_rule
- 컬럼: shuttle_stop_candidate(자동매칭 4개), shuttle_doc_job_log(base_job_id, route_label)
- promoted_job_id 제거

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[SoT (변경 금지)]

1. latest PARSE_MATCH 스냅샷 기준 후보 표시
2. stale 후보 승인/거절 차단
3. promote는 latest만
4. route_stop 스냅샷 누적 (is_active 0/1)
5. alias 등록 시 latest 1건만 live rematch
6. 추천 canonical은 only_unmatched=1에서만
7. 신뢰도 표시는 표시/집계 전용
8. LOW 필터 + Promote 경고 (v0.6-19)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[체크리스트 — v0.6-21]

1. 웹 (LOW 승인 게이트)
   - route_review에서 match_method='like_prefix' pending 후보 선택
   - 체크박스 미체크로 Approve → "확인 체크 후" 에러 확인
   - 체크박스 체크 후 Approve → 정상 승인 확인

2. 웹 (alias 검증)
   - 존재하지 않는 canonical 입력 → "canonical not found" 차단 확인
   - 2글자 이하 raw_stop_name(예: "역")에서 alias 등록 → "too short" 차단 확인
   - 정상 canonical 입력 → alias 저장 + live rematch 확인

3. Workbench (sql/v0.6-21_validation.sql)
   - 8개 쿼리 실행
   - (4) alias canonical 존재 확인: master_match 모두 >= 1
   - (5) alias_text 길이: '<=2 (blocked)' = 0

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Git 커밋 대기 중]

- v0.6-18: UI 개선
- v0.6-19: only_low 필터 + Promote 경고
- v0.6-20: seoul stop_master 실데이터 import 스크립트/검증
- v0.6-21: LOW 승인 체크 게이트 + alias 등록 검증 강화

[SQL/Import 실행 원칙]

- DDL/검증쿼리/데이터 Import/UPDATE는 Cursor PC 앱(터미널/Workbench)에서만 실행
- GPT 대화에서는 실행 결과(row count, EXPLAIN type/key, 에러 메시지)만 공유
- GPT가 결과 기반으로 다음 지시 제공
```

---

위 내용을 GPT에 붙여넣은 뒤, "다음 작업 지시서 줘" 또는 "v0.6-22에서 ~ 구현해줘" 등 요청하시면 됩니다.
