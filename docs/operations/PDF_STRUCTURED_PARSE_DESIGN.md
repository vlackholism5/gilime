# PDF 구조화 파싱 (운영형) 설계

## 1. 목적

- PDF 1회 파싱으로 **텍스트에서 얻을 수 있는 모든 정보**를 고정 스키마로 출력
- 정류장명·정류장ID는 노선도 이미지에만 있는 경우가 많아 **null 허용** → 후속 보정(수동/GPT/별도 파일)으로 채움
- 운영 시 동일한 컬럼 구조로 감사·재처리·편집 가능

## 2. 흐름

```
[PDF] → [1회 파싱] → [고정 스키마 CSV/JSON]
                           ↓
              [정류장명·ID null인 행 허용]
                           ↓
    [run_job 또는 Import에서 CSV 읽어 후보 생성]
                           ↓
    [정류장 매칭: CSV에 ID 있으면 사용, 없으면 DB 매칭/수동]
```

## 3. 출력 스키마 (CSV 컬럼)

| 컬럼 | 설명 | 파싱 소스 | null |
|------|------|-----------|------|
| route_label | 노선 라벨 (운행구간 등) | 텍스트 | |
| 연번 | 1, 2, … | 텍스트 | |
| 자치구 | 금천구 등 | 텍스트 | ✓ |
| 운행대수 | 22대(오전11/오후11) | 텍스트 | ✓ |
| 운행시간 | 05:00～22:00 | 텍스트 | ✓ |
| 운행구간_텍스트 | 석수역~시흥대로~구로디지털단지역 | 텍스트 | ✓ |
| 운행거리 | 12.6km | 텍스트 | ✓ |
| 배정대수 | 8대 | 텍스트 | ✓ |
| 운행횟수 | 대당 16회 | 텍스트 | ✓ |
| 배차간격 | 10분~20분 | 텍스트 | ✓ |
| seq_in_route | 노선 내 순번 (1부터) | 파생 | |
| raw_stop_name | 정류장명 후보 (운행구간_텍스트 분할) | 파생 | |
| 정류장명 | 표준 정류장명 (이미지/수동) | 이미지/수동 | ✓ |
| 정류장ID | seoul_bus_stop_master 등 ID | 이미지/수동 | ✓ |

- **raw_stop_name**: 운행구간_텍스트를 `~`, `→`, `↔` 등으로 분할한 값. 정류장명이 비어 있으면 이 값으로 후보 생성.
- **정류장명·정류장ID**: 이미지 파싱 또는 수동 편집으로 채우는 컬럼. 비어 있으면 null.

## 4. 구현

- **스크립트**: `scripts/python/parse_shuttle_pdf_to_structured.py`
  - 입력: PDF 경로
  - 출력: CSV (고정 스키마), 선택적 JSON
  - 텍스트 추출: pypdf 또는 기존 extract_text.py 호출
  - 파싱: 자치구, 운행대수, 운행시간, 연번별 운행구간·운행거리·배정대수·배차간격 추출 후, 운행구간_텍스트 분할로 raw_stop_name·seq_in_route 생성
- **연동**: run_job.php에서 STRUCTURED_PARSE_SCRIPT가 설정되어 있고 해당 스크립트 파일이 있으면 우선 호출 → 출력 CSV 읽기 → 후보 생성. 실패 또는 스크립트 미설정 시 기존 parse_shuttle_pdf() 폴백. 기본값: `scripts/python/parse_shuttle_pdf_to_structured.py` (파일 없으면 폴백).

## 5. 운영 시나리오

1. **일반**: 관리자 문서 상세에서 "파싱·매칭 실행" → PDF 1회 파싱 → CSV 생성 → 후보 DB 적재 (정류장ID null 허용)
2. **보정**: CSV 내보내기 → 정류장명·정류장ID 수동 편집 → 검수 결과 일괄 반영 또는 동일 CSV 재업로드
3. **노선도 이미지**: 정류장 목록이 이미지 전용이면 CSV의 정류장명·ID는 비워 두고, 별도 입력(수동/GPT)으로 채움
