# v1.6 Release Gate (MVP3 Admin Alert Ops)

## 스모크 S1~S7

| # | 항목 | 절차 |
|---|------|------|
| **S1** | alert_ops 로드·필터 | `/admin/alert_ops.php` 접속 → 목록 로드 확인. event_type / route_label / published_from / published_to 필터 적용 후 재요청 → 결과 변경 확인. |
| **S2** | admin에서 알림 1건 생성 | alert_ops 상단 "새 알림 작성" 폼에서 event_type, title, ref_id, route_label, published_at(필수) 입력 후 제출. "created" 또는 "duplicate ignored" muted 메시지 + 리스트 상단/강조 확인. |
| **S3** | user 알림 노출 확인 | `/user/alerts.php?route_label=R1` 접속 → S2에서 만든 알림이 노출되는지 확인. |
| **S4** | deliveries 1건 기록 확인 | 사용자 알림 페이지 진입 시 record_alert_delivery로 app_alert_deliveries에 기록. `/admin/alert_event_audit.php`에서 alert_event_id 또는 user_id로 필터 → 1건 이상 확인. UNIQUE로 중복 0건. |
| **S5** | create contract (v1.6-06) | 필수값(event_type, title, ref_id, route_label, published_at) 누락 시 create 차단 + 메시지. 동일 입력 2회 시 1회 created, 2회 duplicate ignored. |
| **S6** | audit drilldown + summary (v1.6-07) | event_id/user_id/channel/status/since 필터. 상단 요약 1줄(delivery_cnt, min/max created_at). event_id → alert_ops, user_id → audit 드릴다운. |
| **S7** | alerts delivery guard (v1.6-08) | user_id 미확정이면 delivery 기록 안 함. 동일 요청에서 렌더 목록만 루프 1회 기록. 새로고침 시 deliveries 증가 없음(ON DUPLICATE KEY UPDATE). |

## 실행 순서

1. S1 → S2 → S3 → S4 → S5 → S6 → S7 순서 권장.

---

## Evidence (v1.6-10 S5/S6/S7 — 결과 붙여넣기 후 채움)

Workbench에서 아래 SQL 실행 후 결과를 해당 위치에 붙여넣고, 브라우저 증거를 요약해 채운 뒤 S5/S6/S7 판정을 내립니다.

### S5 (Create contract)

| 항목 | 결과 붙여넣기 | 기대 |
|------|----------------|------|
| **(A) events top 5** | 1 row: id=4, event_type=update, title=[E2E test] v1.4-10, ref_type=route, ref_id=1, route_label=R1, content_hash=3594e7d4…, published_at=2026-02-11 02:39:37 | 최신 id=4 → EID |
| **(B) content_hash 중복** | **0 rows** | **0 rows** ✓ |
| **폼 2회 submit** | 동일 payload 2회 제출 시 `flash=duplicate ignored&event_id=N` 리다이렉트, 화면 "duplicate ignored" 표시 및 해당 행 highlight 확인(브라우저 증거) | ✓ |

- **EID** (위 A 최신 id): **4**

### S6 (Audit drilldown + summary)

EID = **4**

| 항목 | 결과 붙여넣기 | 기대 |
|------|----------------|------|
| **(A) 요약** delivery_cnt, min_created, max_created | delivery_cnt=2, min_created=2026-02-11 02:39:54, max_created=2026-02-11 03:14:25 | — |
| **(B) 리스트 20** | 2 rows: id=67 (user_id=2, channel=web, status=shown), id=16 (user_id=1, channel=web, status=shown) | — |
| **(C) deliveries 중복** | **0 rows** | **0 rows** ✓ |

### S7 (Delivery guard)

둘 중 하나만 채우면 됨.

- **옵션 1 (세션 없음):** 시크릿/쿠키 삭제 후 `/user/alerts.php?route_label=R1` 접속 → EID 기준 delivery_cnt 재조회 → **증가 없음** ✓
- **옵션 2 (세션 있음):** 일반 창에서 동일 URL 접속 → delivery_cnt 1 증가 ✓ / 같은 페이지 **새로고침** → delivery_cnt **불변** ✓

- **채움:** S7 OK: 시크릿(세션 없음)으로 /user/alerts.php?route_label=R1 접속 시 EID=4 delivery_cnt 증가 없음(guard 동작).

- **S7 증거 보강(선택, 리뷰용):** 확인한 것만 1줄 기입. 불확실하면 비워두고 PASS 유지.
  - 옵션 A: `S7 보강: 시크릿에서는 EID=4가 렌더 목록에 포함되지 않아(record loop 미실행) delivery_cnt 불변.`
  - 옵션 B: `S7 보강: 시크릿(세션 없음, user_id<=0)에서 record_alert_delivery 호출이 스킵되어 delivery_cnt 불변.`

---

### 최종 요약 (현재 시점)

**S5 (Create contract) — OK**  
- 동일 payload 2회 submit 시 `flash=duplicate ignored&event_id=N` 리다이렉트 확인, 화면에 "duplicate ignored" 표시 및 해당 행 highlight 확인(브라우저 증거).  
- content_hash `HAVING COUNT(*)>1` → **0 rows** (DB 증거).

**S6 (Audit drilldown + summary) — OK**  
- EID 기준 delivery_cnt ≥ 1 충족(현재 EID=4에서 2건), list 20에 실제 rows 존재.  
- (user_id, alert_event_id, channel) 중복 `HAVING COUNT(*)>1` → **0 rows** (UNIQUE 정상).

**S7 (Delivery guard) — OK**  
- 시크릿(세션 없음)으로 /user/alerts.php?route_label=R1 접속 시 EID=4 delivery_cnt 증가 없음(guard 동작).

---

### S7을 끝내는 최소 절차 (옵션 1 추천)

1. 시크릿 창 열기  
2. `/user/alerts.php?route_label=R1` 접속  
3. Workbench에서 `SELECT COUNT(*) AS delivery_cnt FROM app_alert_deliveries WHERE alert_event_id = 4;` 실행  
4. 시크릿 접속 **전/후** delivery_cnt가 증가하지 않으면 S7 OK  

**S7에 남길 1줄 예시(복붙):**  
`S7 OK: 시크릿(세션 없음)으로 /user/alerts.php?route_label=R1 접속 시 EID=4 delivery_cnt 증가 없음(guard 동작).`

---

### 판정 (결과 채운 후)

| # | 항목 | 판정 | 비고 |
|---|------|:----:|------|
| S5 | create contract | **OK** | 폼 2회 submit + content_hash 0 rows |
| S6 | audit drilldown + summary | **OK** | delivery_cnt=2, list 2건, 중복 0 rows |
| S7 | delivery guard | **OK** | 시크릿 접속 시 delivery_cnt 증가 없음(guard 동작) |

- **FAIL 시:** 원인 분기 + 최소 수정 체크리스트(5줄 이내)를 아래에 적습니다.

---

### push 전 점검 (최소 3개)

1. **/admin/alert_ops.php** — created/duplicate 모두 `event_id` 붙고 highlight 되는지  
2. **/admin/alert_event_audit.php?event_id=4** — summary 1줄 + list 나오고, event_id/user_id 드릴다운 링크 정상인지  
3. **/user/alerts.php?route_label=R1&page=1** — 새로고침해도 delivery 추가 증가 없음(UNIQUE + upsert)

---

### 최종 통과 시 (S7 1줄 채운 후)

- **v1.6-10 Gate: PASS** (S5/S6/S7 OK)
- **Action:** `git push origin main`

1. **alert_ops 생성** — created/duplicate 모두 `event_id`가 URL에 붙는지, 목록에서 해당 행 highlight 동작하는지.
2. **audit 필터** — `event_id` 파라미터로 링크 정상(alert_ops↔audit, audit 내 user_id 드릴다운), 무한루프/잘못된 파라미터명 없음.
3. **user/alerts** — delivery는 렌더 목록만 기록, pagination 이동 시 해당 페이지만 증가, 새로고침 시 추가 증가 없음.

---

## Evidence 복붙용 SQL 블록

**실행 순서:** 1) (A) 실행 → 최신 row의 `id`를 EID로 확정 → 2) (B) 실행 → 3) 아래 "(C)(D)(E) EID 넣은 버전"에서 `4`를 EID로 바꾼 뒤 순서대로 실행.

```sql
-- (A) events top 5 — EID 확정
SELECT id, event_type, title, ref_type, ref_id, route_label, content_hash, published_at, created_at
FROM app_alert_events
WHERE ref_type='route' AND ref_id=1 AND route_label='R1'
ORDER BY id DESC
LIMIT 5;

-- (B) content_hash 중복 확인 — 기대 0 rows
SELECT content_hash, COUNT(*) AS c
FROM app_alert_events
WHERE ref_type='route' AND ref_id=1 AND route_label='R1'
GROUP BY content_hash
HAVING COUNT(*) > 1;
```

**EID 확정 후 (C)(D)(E) — 아래 `4`를 (A)에서 나온 EID로 바꾼 뒤 순서대로 실행.**

```sql
-- (C) deliveries 요약 — 4를 EID로 치환
SELECT COUNT(*) AS delivery_cnt, MIN(created_at) AS min_created, MAX(created_at) AS max_created
FROM app_alert_deliveries
WHERE alert_event_id = 4;

-- (D) deliveries list 20 — 4를 EID로 치환
SELECT id, alert_event_id, user_id, channel, status, sent_at, created_at
FROM app_alert_deliveries
WHERE alert_event_id = 4
ORDER BY id DESC
LIMIT 20;

-- (E) deliveries 중복 확인 — 기대 0 rows. 4를 EID로 치환
SELECT user_id, alert_event_id, channel, COUNT(*) AS c
FROM app_alert_deliveries
WHERE alert_event_id = 4
GROUP BY user_id, alert_event_id, channel
HAVING COUNT(*) > 1;
```

---

**이전 판정 (v1.6-05):** S1~S4 통과. EID=4, delivery_cnt=2, 중복 0 rows.
